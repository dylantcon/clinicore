using Core.CliniCore.ClinicalDoc;
using Core.CliniCore.Commands;
using Core.CliniCore.Commands.Clinical;
using Core.CliniCore.Domain;
using Core.CliniCore.Domain.Enumerations;
using GUI.CliniCore.Commands;
using GUI.CliniCore.Services;
using System.Collections.ObjectModel;
using MauiCommand = System.Windows.Input.ICommand;

namespace GUI.CliniCore.ViewModels
{
    /// <summary>
    /// ViewModel for Clinical Document Edit/Create page
    /// Handles both creating new documents and editing existing ones
    /// Manages 5 entry types: Observation, Assessment, Diagnosis, Plan, Prescription
    /// </summary>
    [QueryProperty(nameof(DocumentIdString), "documentId")]
    [QueryProperty(nameof(PatientIdString), "patientId")]
    [QueryProperty(nameof(PhysicianIdString), "physicianId")]
    [QueryProperty(nameof(AppointmentIdString), "appointmentId")]
    public partial class ClinicalDocumentEditViewModel : BaseViewModel
    {
        private readonly CommandFactory _commandFactory;
        private readonly INavigationService _navigationService;
        private readonly SessionManager _sessionManager;
        private readonly ProfileRegistry _profileRegistry = ProfileRegistry.Instance;

        private Guid? _documentId;
        private Guid? _patientId;
        private Guid? _physicianId;
        private Guid? _appointmentId;
        private ClinicalDocument? _document;

        // Mode detection
        public bool IsCreateMode => !_documentId.HasValue || _documentId.Value == Guid.Empty;
        public bool IsEditMode => !IsCreateMode;

        // Query properties for navigation
        public string DocumentIdString
        {
            set
            {
                if (Guid.TryParse(value, out var guid))
                {
                    _documentId = guid;
                    LoadDocumentCommand.Execute(null);
                }
            }
        }

        public string PatientIdString
        {
            set
            {
                if (Guid.TryParse(value, out var guid))
                {
                    _patientId = guid;
                    OnPropertyChanged(nameof(PatientInfo));
                    (SaveCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        public string PhysicianIdString
        {
            set
            {
                if (Guid.TryParse(value, out var guid))
                {
                    _physicianId = guid;
                    OnPropertyChanged(nameof(PhysicianInfo));
                    (SaveCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        public string AppointmentIdString
        {
            set
            {
                if (Guid.TryParse(value, out var guid))
                {
                    _appointmentId = guid;
                }
            }
        }

        // Document properties
        private string _chiefComplaint = string.Empty;
        public string ChiefComplaint
        {
            get => _chiefComplaint;
            set
            {
                if (SetProperty(ref _chiefComplaint, value))
                {
                    UpdateCompletionStatus();
                    (SaveCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        // Display info
        public string PatientInfo
        {
            get
            {
                if (_patientId.HasValue)
                {
                    var patient = _profileRegistry.GetProfileById(_patientId.Value) as PatientProfile;
                    return patient != null ? $"Patient: {patient.Name}" : "Patient: Unknown";
                }
                return "Patient: Not selected";
            }
        }

        public string PhysicianInfo
        {
            get
            {
                if (_physicianId.HasValue)
                {
                    var physician = _profileRegistry.GetProfileById(_physicianId.Value) as PhysicianProfile;
                    return physician != null ? $"Physician: Dr. {physician.Name}" : "Physician: Unknown";
                }
                return "Physician: Not selected";
            }
        }

        // Entry collections
        public ObservableCollection<ObservationDisplayModel> Observations { get; } = new();
        public ObservableCollection<AssessmentDisplayModel> Assessments { get; } = new();
        public ObservableCollection<DiagnosisDisplayModel> Diagnoses { get; } = new();
        public ObservableCollection<PlanDisplayModel> Plans { get; } = new();
        public ObservableCollection<PrescriptionDisplayModel> Prescriptions { get; } = new();

        // New entry forms
        private string _newObservation = string.Empty;
        public string NewObservation
        {
            get => _newObservation;
            set
            {
                if (SetProperty(ref _newObservation, value))
                {
                    (AddObservationCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newObservationType = ObservationType.PhysicalExam.ToString();
        public string NewObservationType
        {
            get => _newObservationType;
            set => SetProperty(ref _newObservationType, value);
        }

        private string _newClinicalImpression = string.Empty;
        public string NewClinicalImpression
        {
            get => _newClinicalImpression;
            set
            {
                if (SetProperty(ref _newClinicalImpression, value))
                {
                    (AddAssessmentCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newDiagnosisDescription = string.Empty;
        public string NewDiagnosisDescription
        {
            get => _newDiagnosisDescription;
            set
            {
                if (SetProperty(ref _newDiagnosisDescription, value))
                {
                    (AddDiagnosisCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newDiagnosisICD10Code = string.Empty;
        public string NewDiagnosisICD10Code
        {
            get => _newDiagnosisICD10Code;
            set => SetProperty(ref _newDiagnosisICD10Code, value);
        }

        private string _newPlanDescription = string.Empty;
        public string NewPlanDescription
        {
            get => _newPlanDescription;
            set
            {
                if (SetProperty(ref _newPlanDescription, value))
                {
                    (AddPlanCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newPrescriptionMedication = string.Empty;
        public string NewPrescriptionMedication
        {
            get => _newPrescriptionMedication;
            set
            {
                if (SetProperty(ref _newPrescriptionMedication, value))
                {
                    (AddPrescriptionCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newPrescriptionDosage = string.Empty;
        public string NewPrescriptionDosage
        {
            get => _newPrescriptionDosage;
            set
            {
                if (SetProperty(ref _newPrescriptionDosage, value))
                {
                    (AddPrescriptionCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newPrescriptionFrequency = string.Empty;
        public string NewPrescriptionFrequency
        {
            get => _newPrescriptionFrequency;
            set
            {
                if (SetProperty(ref _newPrescriptionFrequency, value))
                {
                    (AddPrescriptionCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private string _newPrescriptionDuration = string.Empty;
        public string NewPrescriptionDuration
        {
            get => _newPrescriptionDuration;
            set => SetProperty(ref _newPrescriptionDuration, value);
        }

        private Guid? _newPrescriptionDiagnosisId;
        public Guid? NewPrescriptionDiagnosisId
        {
            get => _newPrescriptionDiagnosisId;
            set
            {
                if (SetProperty(ref _newPrescriptionDiagnosisId, value))
                {
                    (AddPrescriptionCommand as RelayCommand)?.RaiseCanExecuteChanged();
                }
            }
        }

        private DiagnosisDisplayModel? _selectedDiagnosisForPrescription;
        public DiagnosisDisplayModel? SelectedDiagnosisForPrescription
        {
            get => _selectedDiagnosisForPrescription;
            set
            {
                if (SetProperty(ref _selectedDiagnosisForPrescription, value))
                {
                    NewPrescriptionDiagnosisId = value?.Id;
                }
            }
        }

        // Completion tracking
        private string _completionStatus = string.Empty;
        public string CompletionStatus
        {
            get => _completionStatus;
            set => SetProperty(ref _completionStatus, value);
        }

        private string _completionColor = "#666";
        public string CompletionColor
        {
            get => _completionColor;
            set => SetProperty(ref _completionColor, value);
        }

        // Enum options for pickers
        public List<string> ObservationTypes { get; } = Enum.GetNames(typeof(ObservationType)).ToList();
        public List<string> DiagnosisSeverities { get; } = Enum.GetNames(typeof(DiagnosisSeverity)).ToList();

        // Available diagnoses for prescription linking
        public ObservableCollection<DiagnosisDisplayModel> AvailableDiagnoses => Diagnoses;

        // Commands
        public MauiCommand LoadDocumentCommand { get; }
        public MauiCommand SaveCommand { get; }
        public MauiCommand AddObservationCommand { get; }
        public MauiCommand AddAssessmentCommand { get; }
        public MauiCommand AddDiagnosisCommand { get; }
        public MauiCommand AddPlanCommand { get; }
        public MauiCommand AddPrescriptionCommand { get; }
        public MauiCommand BackCommand { get; }

        public ClinicalDocumentEditViewModel(
            CommandFactory commandFactory,
            INavigationService navigationService,
            SessionManager sessionManager)
        {
            _commandFactory = commandFactory ?? throw new ArgumentNullException(nameof(commandFactory));
            _navigationService = navigationService ?? throw new ArgumentNullException(nameof(navigationService));
            _sessionManager = sessionManager ?? throw new ArgumentNullException(nameof(sessionManager));

            Title = "Clinical Document";

            // Load command (for edit mode)
            var viewCoreCommand = _commandFactory.CreateCommand(ViewClinicalDocumentCommand.Key);
            LoadDocumentCommand = new MauiCommandAdapter(
                viewCoreCommand!,
                parameterBuilder: BuildLoadParameters,
                sessionProvider: () => _sessionManager.CurrentSession,
                resultHandler: HandleLoadResult,
                viewModel: this
            );

            // Save command
            SaveCommand = new AsyncRelayCommand(
                execute: async () => await ExecuteSaveAsync(),
                canExecute: CanSave
            );

            // Add entry commands
            AddObservationCommand = new RelayCommand(
                execute: ExecuteAddObservation,
                canExecute: CanAddObservation
            );

            AddAssessmentCommand = new RelayCommand(
                execute: ExecuteAddAssessment,
                canExecute: CanAddAssessment
            );

            AddDiagnosisCommand = new RelayCommand(
                execute: ExecuteAddDiagnosis,
                canExecute: CanAddDiagnosis
            );

            AddPlanCommand = new RelayCommand(
                execute: ExecuteAddPlan,
                canExecute: CanAddPlan
            );

            AddPrescriptionCommand = new RelayCommand(
                execute: ExecuteAddPrescription,
                canExecute: CanAddPrescription
            );

            // Back command
            BackCommand = new AsyncRelayCommand(async () =>
            {
                if (_documentId.HasValue && _documentId.Value != Guid.Empty)
                {
                    await _navigationService.NavigateToAsync($"ClinicalDocumentDetailPage?documentId={_documentId.Value}");
                }
                else if (_patientId.HasValue)
                {
                    await _navigationService.NavigateToAsync($"ClinicalDocumentListPage?patientId={_patientId.Value}");
                }
                else
                {
                    await _navigationService.NavigateToAsync("ClinicalDocumentListPage");
                }
            });

            UpdateCompletionStatus();
        }

        private CommandParameters BuildLoadParameters()
        {
            return new CommandParameters()
                .SetParameter(ViewClinicalDocumentCommand.Parameters.DocumentId, _documentId);
        }

        private void HandleLoadResult(CommandResult result)
        {
            if (result.Success && result.Data is ClinicalDocument document)
            {
                _document = document;
                _patientId = document.PatientId;
                _physicianId = document.PhysicianId;

                // Load document properties
                ChiefComplaint = document.ChiefComplaint ?? string.Empty;

                // Load entries
                LoadObservations(document);
                LoadAssessments(document);
                LoadDiagnoses(document);
                LoadPlans(document);
                LoadPrescriptions(document);

                // Update display
                OnPropertyChanged(nameof(PatientInfo));
                OnPropertyChanged(nameof(PhysicianInfo));
                OnPropertyChanged(nameof(IsCreateMode));
                OnPropertyChanged(nameof(IsEditMode));
                UpdateCompletionStatus();

                Title = "Edit Clinical Document";
                ClearValidation();
            }
            else
            {
                Title = "Create Clinical Document";
            }
        }

        private void LoadObservations(ClinicalDocument document)
        {
            Observations.Clear();
            var observations = document.GetEntriesByType<ObservationEntry>();
            foreach (var obs in observations)
            {
                Observations.Add(new ObservationDisplayModel
                {
                    Id = obs.EntryId,
                    Type = obs.Type.ToString(),
                    Description = obs.Description,
                    Value = obs.Value ?? string.Empty,
                    Unit = obs.Unit ?? string.Empty
                });
            }
        }

        private void LoadAssessments(ClinicalDocument document)
        {
            Assessments.Clear();
            var assessments = document.GetEntriesByType<AssessmentEntry>();
            foreach (var assessment in assessments)
            {
                Assessments.Add(new AssessmentDisplayModel
                {
                    Id = assessment.EntryId,
                    Notes = assessment.Notes
                });
            }
        }

        private void LoadDiagnoses(ClinicalDocument document)
        {
            Diagnoses.Clear();
            var diagnoses = document.GetEntriesByType<DiagnosisEntry>();
            foreach (var diagnosis in diagnoses)
            {
                Diagnoses.Add(new DiagnosisDisplayModel
                {
                    Id = diagnosis.EntryId,
                    Code = diagnosis.Code,
                    Description = diagnosis.Description,
                    Severity = diagnosis.Severity.ToString()
                });
            }
        }

        private void LoadPlans(ClinicalDocument document)
        {
            Plans.Clear();
            var plans = document.GetEntriesByType<PlanEntry>();
            foreach (var plan in plans)
            {
                Plans.Add(new PlanDisplayModel
                {
                    Id = plan.EntryId,
                    Description = plan.Description
                });
            }
        }

        private void LoadPrescriptions(ClinicalDocument document)
        {
            Prescriptions.Clear();
            var prescriptions = document.GetEntriesByType<PrescriptionEntry>();
            foreach (var prescription in prescriptions)
            {
                Prescriptions.Add(new PrescriptionDisplayModel
                {
                    Id = prescription.EntryId,
                    MedicationName = prescription.MedicationName,
                    Dosage = prescription.Dosage,
                    Frequency = prescription.Frequency,
                    Duration = prescription.Duration ?? string.Empty,
                    DiagnosisId = prescription.DiagnosisId
                });
            }
        }

        private async Task ExecuteSaveAsync()
        {
            try
            {
                if (IsCreateMode)
                {
                    await CreateDocumentAsync();
                }
                else
                {
                    await UpdateDocumentAsync();
                }
            }
            catch (Exception ex)
            {
                ValidationErrors.Clear();
                ValidationErrors.Add($"Error saving document: {ex.Message}");
            }
        }

        private async Task CreateDocumentAsync()
        {
            if (!_patientId.HasValue || !_physicianId.HasValue)
            {
                ValidationErrors.Clear();
                ValidationErrors.Add("Patient and Physician are required");
                return;
            }

            var createCommand = _commandFactory.CreateCommand(CreateClinicalDocumentCommand.Key);
            var parameters = new CommandParameters()
                .SetParameter(CreateClinicalDocumentCommand.Parameters.PatientId, _patientId.Value)
                .SetParameter(CreateClinicalDocumentCommand.Parameters.PhysicianId, _physicianId.Value)
                .SetParameter(CreateClinicalDocumentCommand.Parameters.ChiefComplaint, ChiefComplaint);

            if (_appointmentId.HasValue && _appointmentId.Value != Guid.Empty)
            {
                parameters.SetParameter(CreateClinicalDocumentCommand.Parameters.AppointmentId, _appointmentId.Value);
            }

            var result = createCommand!.Execute(parameters, _sessionManager.CurrentSession!);

            if (result.Success && result.Data is ClinicalDocument newDocument)
            {
                _document = newDocument;
                _documentId = newDocument.DocumentId;

                // Navigate to detail page
                await _navigationService.NavigateToAsync($"ClinicalDocumentDetailPage?documentId={_documentId.Value}");
            }
            else
            {
                ValidationErrors.Clear();
                ValidationErrors.Add(result.Message ?? "Failed to create document");
            }
        }

        private async Task UpdateDocumentAsync()
        {
            if (_document == null || !_documentId.HasValue) return;

            // Update chief complaint if changed
            if (_document.ChiefComplaint != ChiefComplaint)
            {
                var updateCommand = _commandFactory.CreateCommand(UpdateClinicalDocumentCommand.Key);
                var parameters = new CommandParameters()
                    .SetParameter(UpdateClinicalDocumentCommand.Parameters.DocumentId, _documentId.Value)
                    .SetParameter(UpdateClinicalDocumentCommand.Parameters.ChiefComplaint, ChiefComplaint);

                var result = updateCommand!.Execute(parameters, _sessionManager.CurrentSession!);

                if (!result.Success)
                {
                    ValidationErrors.Clear();
                    ValidationErrors.Add(result.Message ?? "Failed to update document");
                    return;
                }
            }

            // Navigate to detail page
            await _navigationService.NavigateToAsync($"ClinicalDocumentDetailPage?documentId={_documentId.Value}");
        }

        private void ExecuteAddObservation()
        {
            if (_document == null || !_documentId.HasValue) return;

            if (!Enum.TryParse<ObservationType>(NewObservationType, out var observationType))
            {
                ValidationErrors.Clear();
                ValidationErrors.Add("Invalid observation type");
                return;
            }

            var addCommand = _commandFactory.CreateCommand(AddObservationCommand.Key);
            var parameters = new CommandParameters()
                .SetParameter(Core.CliniCore.Commands.Clinical.AddObservationCommand.Parameters.DocumentId, _documentId.Value)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddObservationCommand.Parameters.Type, observationType)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddObservationCommand.Parameters.Description, NewObservationDescription);

            if (!string.IsNullOrWhiteSpace(NewObservationValue))
            {
                parameters.SetParameter(Core.CliniCore.Commands.Clinical.AddObservationCommand.Parameters.Value, NewObservationValue);
            }

            if (!string.IsNullOrWhiteSpace(NewObservationUnit))
            {
                parameters.SetParameter(Core.CliniCore.Commands.Clinical.AddObservationCommand.Parameters.Unit, NewObservationUnit);
            }

            var result = addCommand!.Execute(parameters, _sessionManager.CurrentSession!);

            if (result.Success && result.Data is ObservationEntry entry)
            {
                Observations.Add(new ObservationDisplayModel
                {
                    Id = entry.EntryId,
                    Type = entry.Type.ToString(),
                    Description = entry.Description,
                    Value = entry.Value ?? string.Empty,
                    Unit = entry.Unit ?? string.Empty
                });

                // Reset form
                NewObservationDescription = string.Empty;
                NewObservationValue = string.Empty;
                NewObservationUnit = string.Empty;
                UpdateCompletionStatus();
                ClearValidation();
            }
            else
            {
                ValidationErrors.Clear();
                ValidationErrors.Add(result.Message ?? "Failed to add observation");
            }
        }

        private void ExecuteAddAssessment()
        {
            if (_document == null || !_documentId.HasValue) return;

            var addCommand = _commandFactory.CreateCommand(Core.CliniCore.Commands.Clinical.AddAssessmentCommand.Key);
            var parameters = new CommandParameters()
                .SetParameter(Core.CliniCore.Commands.Clinical.AddAssessmentCommand.Parameters.DocumentId, _documentId.Value)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddAssessmentCommand.Parameters.Notes, NewAssessmentNotes);

            var result = addCommand!.Execute(parameters, _sessionManager.CurrentSession!);

            if (result.Success && result.Data is AssessmentEntry entry)
            {
                Assessments.Add(new AssessmentDisplayModel
                {
                    Id = entry.EntryId,
                    Notes = entry.Notes
                });

                NewAssessmentNotes = string.Empty;
                UpdateCompletionStatus();
                ClearValidation();
            }
            else
            {
                ValidationErrors.Clear();
                ValidationErrors.Add(result.Message ?? "Failed to add assessment");
            }
        }

        private void ExecuteAddDiagnosis()
        {
            if (_document == null || !_documentId.HasValue) return;

            if (!Enum.TryParse<DiagnosisSeverity>(NewDiagnosisSeverity, out var severity))
            {
                ValidationErrors.Clear();
                ValidationErrors.Add("Invalid diagnosis severity");
                return;
            }

            var addCommand = _commandFactory.CreateCommand(Core.CliniCore.Commands.Clinical.AddDiagnosisCommand.Key);
            var parameters = new CommandParameters()
                .SetParameter(Core.CliniCore.Commands.Clinical.AddDiagnosisCommand.Parameters.DocumentId, _documentId.Value)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddDiagnosisCommand.Parameters.Code, NewDiagnosisCode)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddDiagnosisCommand.Parameters.Description, NewDiagnosisDescription)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddDiagnosisCommand.Parameters.Severity, severity);

            var result = addCommand!.Execute(parameters, _sessionManager.CurrentSession!);

            if (result.Success && result.Data is DiagnosisEntry entry)
            {
                Diagnoses.Add(new DiagnosisDisplayModel
                {
                    Id = entry.EntryId,
                    Code = entry.Code,
                    Description = entry.Description,
                    Severity = entry.Severity.ToString()
                });

                NewDiagnosisCode = string.Empty;
                NewDiagnosisDescription = string.Empty;
                UpdateCompletionStatus();
                ClearValidation();

                // Notify that available diagnoses changed for prescription form
                OnPropertyChanged(nameof(AvailableDiagnoses));
            }
            else
            {
                ValidationErrors.Clear();
                ValidationErrors.Add(result.Message ?? "Failed to add diagnosis");
            }
        }

        private void ExecuteAddPlan()
        {
            if (_document == null || !_documentId.HasValue) return;

            var addCommand = _commandFactory.CreateCommand(Core.CliniCore.Commands.Clinical.AddPlanCommand.Key);
            var parameters = new CommandParameters()
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPlanCommand.Parameters.DocumentId, _documentId.Value)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPlanCommand.Parameters.Description, NewPlanDescription);

            var result = addCommand!.Execute(parameters, _sessionManager.CurrentSession!);

            if (result.Success && result.Data is PlanEntry entry)
            {
                Plans.Add(new PlanDisplayModel
                {
                    Id = entry.EntryId,
                    Description = entry.Description
                });

                NewPlanDescription = string.Empty;
                UpdateCompletionStatus();
                ClearValidation();
            }
            else
            {
                ValidationErrors.Clear();
                ValidationErrors.Add(result.Message ?? "Failed to add plan");
            }
        }

        private void ExecuteAddPrescription()
        {
            if (_document == null || !_documentId.HasValue) return;

            if (!NewPrescriptionDiagnosisId.HasValue)
            {
                ValidationErrors.Clear();
                ValidationErrors.Add("Please select a diagnosis for this prescription");
                return;
            }

            var addCommand = _commandFactory.CreateCommand(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Key);
            var parameters = new CommandParameters()
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Parameters.DocumentId, _documentId.Value)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Parameters.MedicationName, NewPrescriptionMedication)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Parameters.Dosage, NewPrescriptionDosage)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Parameters.Frequency, NewPrescriptionFrequency)
                .SetParameter(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Parameters.DiagnosisId, NewPrescriptionDiagnosisId.Value);

            if (!string.IsNullOrWhiteSpace(NewPrescriptionDuration))
            {
                parameters.SetParameter(Core.CliniCore.Commands.Clinical.AddPrescriptionCommand.Parameters.Duration, NewPrescriptionDuration);
            }

            var result = addCommand!.Execute(parameters, _sessionManager.CurrentSession!);

            if (result.Success && result.Data is PrescriptionEntry entry)
            {
                Prescriptions.Add(new PrescriptionDisplayModel
                {
                    Id = entry.EntryId,
                    MedicationName = entry.MedicationName,
                    Dosage = entry.Dosage,
                    Frequency = entry.Frequency,
                    Duration = entry.Duration ?? string.Empty,
                    DiagnosisId = entry.DiagnosisId
                });

                NewPrescriptionMedication = string.Empty;
                NewPrescriptionDosage = string.Empty;
                NewPrescriptionFrequency = string.Empty;
                NewPrescriptionDuration = string.Empty;
                NewPrescriptionDiagnosisId = null;
                SelectedDiagnosisForPrescription = null;
                ClearValidation();
            }
            else
            {
                ValidationErrors.Clear();
                ValidationErrors.Add(result.Message ?? "Failed to add prescription");
            }
        }

        // Can execute methods
        private bool CanSave()
        {
            return !string.IsNullOrWhiteSpace(ChiefComplaint) &&
                   _patientId.HasValue &&
                   _physicianId.HasValue;
        }

        private bool CanAddObservation()
        {
            return _document != null &&
                   !string.IsNullOrWhiteSpace(NewObservationDescription);
        }

        private bool CanAddAssessment()
        {
            return _document != null &&
                   !string.IsNullOrWhiteSpace(NewAssessmentNotes);
        }

        private bool CanAddDiagnosis()
        {
            return _document != null &&
                   !string.IsNullOrWhiteSpace(NewDiagnosisCode) &&
                   !string.IsNullOrWhiteSpace(NewDiagnosisDescription);
        }

        private bool CanAddPlan()
        {
            return _document != null &&
                   !string.IsNullOrWhiteSpace(NewPlanDescription);
        }

        private bool CanAddPrescription()
        {
            return _document != null &&
                   Diagnoses.Count > 0 &&
                   NewPrescriptionDiagnosisId.HasValue &&
                   !string.IsNullOrWhiteSpace(NewPrescriptionMedication) &&
                   !string.IsNullOrWhiteSpace(NewPrescriptionDosage) &&
                   !string.IsNullOrWhiteSpace(NewPrescriptionFrequency);
        }

        private void UpdateCompletionStatus()
        {
            int completed = 0;
            int total = 5;

            if (!string.IsNullOrWhiteSpace(ChiefComplaint)) completed++;
            if (Observations.Count > 0) completed++;
            if (Assessments.Count > 0) completed++;
            if (Diagnoses.Count > 0) completed++;
            if (Plans.Count > 0) completed++;

            CompletionStatus = $"Document Completion: {completed}/{total} sections";
            CompletionColor = completed == total ? "#4CAF50" : completed >= 3 ? "#FF9800" : "#F44336";
        }
    }

    // Display models for entry lists
    public class ObservationDisplayModel
    {
        public Guid Id { get; set; }
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public string Unit { get; set; } = string.Empty;
        public string Display => $"{Type}: {Description}" + (!string.IsNullOrWhiteSpace(Value) ? $" = {Value} {Unit}" : "");
    }

    public class AssessmentDisplayModel
    {
        public Guid Id { get; set; }
        public string Notes { get; set; } = string.Empty;
        public string Display => Notes.Length > 60 ? Notes.Substring(0, 60) + "..." : Notes;
    }

    public class DiagnosisDisplayModel
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Severity { get; set; } = string.Empty;
        public string Display => $"[{Code}] {Description} ({Severity})";
        public string SeverityColor => Severity switch
        {
            nameof(DiagnosisSeverity.Mild) => "#4CAF50",
            nameof(DiagnosisSeverity.Moderate) => "#FF9800",
            nameof(DiagnosisSeverity.Severe) => "#F44336",
            _ => "#757575"
        };
    }

    public class PlanDisplayModel
    {
        public Guid Id { get; set; }
        public string Description { get; set; } = string.Empty;
        public string Display => Description.Length > 60 ? Description.Substring(0, 60) + "..." : Description;
    }

    public class PrescriptionDisplayModel
    {
        public Guid Id { get; set; }
        public string MedicationName { get; set; } = string.Empty;
        public string Dosage { get; set; } = string.Empty;
        public string Frequency { get; set; } = string.Empty;
        public string Duration { get; set; } = string.Empty;
        public Guid? DiagnosisId { get; set; }
        public string Display => $"{MedicationName} {Dosage} - {Frequency}" + (!string.IsNullOrWhiteSpace(Duration) ? $" for {Duration}" : "");
    }
}
