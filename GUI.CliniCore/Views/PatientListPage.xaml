<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:GUI.CliniCore.ViewModels"
             xmlns:domain="clr-namespace:Core.CliniCore.Domain;assembly=Core.CliniCore"
             xmlns:icons="clr-namespace:GUI.CliniCore.Resources.Fonts"
             xmlns:converters="clr-namespace:GUI.CliniCore.Converters"
             x:Class="GUI.CliniCore.Views.PatientListPage"
             x:DataType="viewModels:PatientListViewModel"
             Title="{Binding Title}">

    <!-- Configure Shell back button to trigger Back command -->
    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding BackCommand}"/>
    </Shell.BackButtonBehavior>

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:PhysicianAssignmentConverter x:Key="PhysicianAssignmentConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Outer grid to constrain max width on wide screens -->
    <Grid HorizontalOptions="Center" MaximumWidthRequest="1200">
        <Grid RowDefinitions="Auto,*" Padding="10">

        <!-- Search and Actions Bar -->
        <VerticalStackLayout Grid.Row="0" Spacing="10" Margin="0,0,0,10">

            <!-- Back Button -->
            <Button Text="â† Back to Dashboard"
                    Command="{Binding BackCommand}"
                    BackgroundColor="#607D8B"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="40"/>

            <!-- Search Box -->
            <Border Stroke="LightGray" StrokeThickness="1" Background="White" StrokeShape="RoundRectangle 8" Padding="10">
                <Grid ColumnDefinitions="*,100" ColumnSpacing="10">
                    <Entry Grid.Column="0"
                           Placeholder="Search patients by name or username"
                           Text="{Binding SearchText}"
                           TextColor="#333"
                           ClearButtonVisibility="WhileEditing"/>
                    <Button Grid.Column="1"
                            Text="Search"
                            Command="{Binding SearchCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"/>
                </Grid>
            </Border>

            <!-- Physician Selector (Admin Only) - Used for assignment, not filtering -->
            <Border Stroke="#2196F3"
                    StrokeThickness="2"
                    Background="White"
                    StrokeShape="RoundRectangle 8"
                    Padding="10"
                    HorizontalOptions="Fill"
                    IsVisible="{Binding ShowPhysicianFilter}">
                <VerticalStackLayout Spacing="5">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Select Physician for Assignment"
                               FontSize="12"
                               FontAttributes="Bold"
                               TextColor="#666"
                               VerticalOptions="Center"
                               HorizontalOptions="Start"/>
                        <Button Text="Clear Selection"
                                Command="{Binding ClearPhysicianFilterCommand}"
                                BackgroundColor="#9E9E9E"
                                TextColor="White"
                                FontSize="10"
                                Padding="8,4"
                                CornerRadius="4"
                                HeightRequest="28"
                                HorizontalOptions="End"/>
                    </HorizontalStackLayout>
                    <!-- Border around actual clickable picker -->
                    <Border Stroke="#1976D2"
                            StrokeThickness="1"
                            Background="#E3F2FD"
                            StrokeShape="RoundRectangle 6"
                            Padding="5">
                        <Picker ItemsSource="{Binding AvailablePhysicians}"
                                SelectedItem="{Binding SelectedPhysicianFilter}"
                                ItemDisplayBinding="{Binding Name}"
                                Title="Select a physician to assign patients"
                                TextColor="#333"
                                BackgroundColor="Transparent"/>
                    </Border>
                </VerticalStackLayout>
            </Border>

            <!-- My Patients Toggle (Physician Only) -->
            <Border Stroke="#4CAF50"
                    StrokeThickness="2"
                    Background="White"
                    StrokeShape="RoundRectangle 8"
                    Padding="10"
                    HorizontalOptions="Fill"
                    IsVisible="{Binding ShowMyPatientsToggle}">
                <HorizontalStackLayout Spacing="10">
                    <CheckBox IsChecked="{Binding ShowMyPatientsOnly}"/>
                    <Label Text="Show my patients only"
                           VerticalOptions="Center"
                           TextColor="#333"/>
                </HorizontalStackLayout>
            </Border>

            <!-- Assignment Status Filter -->
            <Border Stroke="#FF9800"
                    StrokeThickness="2"
                    Background="White"
                    StrokeShape="RoundRectangle 8"
                    Padding="10"
                    HorizontalOptions="Fill">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Assignment Status"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="#666"/>
                    <!-- Border around actual clickable picker -->
                    <Border Stroke="#F57C00"
                            StrokeThickness="1"
                            Background="#FFF3E0"
                            StrokeShape="RoundRectangle 6"
                            Padding="5">
                        <Picker SelectedIndex="{Binding AssignmentFilterIndex}"
                                Title="Filter by assignment status"
                                TextColor="#333"
                                BackgroundColor="Transparent">
                            <Picker.ItemsSource>
                                <x:Array Type="{x:Type x:String}">
                                    <x:String>All Patients</x:String>
                                    <x:String>Assigned Only</x:String>
                                    <x:String>Unassigned Only</x:String>
                                </x:Array>
                            </Picker.ItemsSource>
                        </Picker>
                    </Border>
                </VerticalStackLayout>
            </Border>

            <!-- Action Buttons (RBAC: Only visible to authorized users) -->
            <Button Text="Create New Patient"
                    Command="{Binding CreatePatientCommand}"
                    BackgroundColor="#4CAF50"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="45"
                    IsVisible="{Binding CanCreatePatient}"/>

        </VerticalStackLayout>

        <!-- Patient List -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">

            <CollectionView ItemsSource="{Binding Patients}"
                           SelectedItem="{Binding SelectedPatient}"
                           SelectionMode="Single">

                <!-- Empty View with proper layout -->
                <CollectionView.EmptyView>
                    <ContentView Padding="20" VerticalOptions="Center">
                        <Border Stroke="#BDBDBD"
                                StrokeThickness="1"
                                Background="#F5F5F5"
                                StrokeShape="RoundRectangle 12"
                                Padding="40"
                                HorizontalOptions="Center">
                            <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                                <Label Text="{x:Static icons:MaterialIcons.Group}"
                                       FontFamily="MaterialIconsRegular"
                                       FontSize="64"
                                       TextColor="#BDBDBD"
                                       HorizontalOptions="Center"/>
                                <Label Text="No patients found"
                                       FontSize="16"
                                       TextColor="#757575"
                                       HorizontalOptions="Center"
                                       FontAttributes="Bold"/>
                                <Label Text="Try adjusting your filters or create a new patient"
                                       FontSize="12"
                                       TextColor="#9E9E9E"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Border>
                    </ContentView>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="domain:PatientProfile">
                        <Border Stroke="LightGray"
                                StrokeThickness="1"
                                Background="White"
                                StrokeShape="RoundRectangle 8"
                                Padding="15"
                                Margin="0,5">

                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">

                                <!-- Patient Info -->
                                <VerticalStackLayout Grid.Column="0" Spacing="5">

                                    <!-- Patient Name -->
                                    <Label Text="{Binding Name}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="#333"/>

                                    <!-- Username -->
                                    <HorizontalStackLayout Spacing="5">
                                        <Label Text="Username:"
                                               FontSize="12"
                                               TextColor="Gray"
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding Username}"
                                               FontSize="12"
                                               TextColor="Gray"/>
                                    </HorizontalStackLayout>

                                    <!-- Age and Gender -->
                                    <HorizontalStackLayout Spacing="10">
                                        <Label FontSize="12" TextColor="Gray">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Age: " FontAttributes="Bold"/>
                                                    <Span Text="{Binding BirthDate, StringFormat='{0:yyyy-MM-dd}'}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <Label FontSize="12" TextColor="Gray">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Gender: " FontAttributes="Bold"/>
                                                    <Span Text="{Binding Gender}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </HorizontalStackLayout>

                                    <!-- Primary Physician Assignment Status -->
                                    <Border BackgroundColor="#E8F5E9"
                                            StrokeThickness="0"
                                            StrokeShape="RoundRectangle 6"
                                            Padding="8,4"
                                            HorizontalOptions="Start"
                                            Margin="0,5,0,0">
                                        <Label FontSize="11" TextColor="#2E7D32">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{x:Static icons:MaterialIcons.LocalHospital}"
                                                          FontFamily="MaterialIconsRegular"
                                                          FontSize="12"/>
                                                    <Span Text=" PCP: " FontAttributes="Bold"/>
                                                    <Span Text="{Binding PrimaryPhysicianId,
                                                                         Converter={StaticResource PhysicianAssignmentConverter}}"
                                                          FontAttributes="Bold"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Border>

                                    <!-- Patient ID (Truncated) -->
                                    <Label FontSize="10" TextColor="LightGray">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="ID: "/>
                                                <Span Text="{Binding Id, StringFormat='{0:N}'}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                </VerticalStackLayout>

                                <!-- Assign Button -->
                                <Button Grid.Column="1"
                                        Text="Assign"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PatientListViewModel}}, Path=AssignPatientCommand}"
                                        CommandParameter="{Binding Id}"
                                        IsVisible="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PatientListViewModel}}, Path=CanAssignPatients}"
                                        BackgroundColor="#FF9800"
                                        TextColor="White"
                                        CornerRadius="6"
                                        WidthRequest="80"
                                        HeightRequest="40"
                                        VerticalOptions="Center"/>

                            </Grid>

                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

            </CollectionView>

        </RefreshView>

        <!-- Validation Errors -->
        <CollectionView Grid.Row="1"
                       ItemsSource="{Binding ValidationErrors}"
                       IsVisible="{Binding HasValidationErrors}"
                       VerticalOptions="Start"
                       Margin="10">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Stroke="#F44336"
                            StrokeThickness="1"
                            Background="#FFEBEE"
                            StrokeShape="RoundRectangle 8"
                            Padding="10"
                            Margin="0,2">
                        <Label Text="{Binding .}"
                               TextColor="#D32F2F"
                               FontSize="12"/>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        </Grid>
    </Grid>

</ContentPage>
