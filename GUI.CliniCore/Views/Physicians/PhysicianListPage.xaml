<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:GUI.CliniCore.ViewModels.Physicians"
             xmlns:converters="clr-namespace:GUI.CliniCore.Converters"
             xmlns:domain="clr-namespace:Core.CliniCore.Domain.Users.Concrete;assembly=Core.CliniCore"
             xmlns:icons="clr-namespace:GUI.CliniCore.Resources.Fonts"
             xmlns:shared="clr-namespace:GUI.CliniCore.Views.Shared"
             x:Class="GUI.CliniCore.Views.Physicians.PhysicianListPage"
             x:DataType="viewModels:PhysicianListViewModel"
             Title="{Binding Title}">

    <!-- Configure Shell back button to trigger Back command -->
    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding BackCommand}"/>
    </Shell.BackButtonBehavior>

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:SpecializationsConverter x:Key="SpecializationsConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Outer grid to constrain max width on wide screens -->
    <Grid HorizontalOptions="Center" MaximumWidthRequest="1200">
        <Grid RowDefinitions="Auto,*" Padding="10">

        <!-- Search and Actions Bar -->
        <VerticalStackLayout Grid.Row="0" Spacing="10" Margin="0,0,0,10">

            <!-- Back Button -->
            <Border BackgroundColor="#607D8B" StrokeThickness="0" Padding="12,10" StrokeShape="RoundRectangle 8" HeightRequest="40">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding BackCommand}"/>
                </Border.GestureRecognizers>
                <HorizontalStackLayout Spacing="8" HorizontalOptions="Center" VerticalOptions="Center">
                    <Label Text="{x:Static icons:MaterialIcons.ArrowBack}" FontFamily="MaterialIconsRegular" FontSize="18" TextColor="White" VerticalOptions="Center"/>
                    <Label Text="Back to Dashboard" TextColor="White" FontSize="14" VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </Border>

            <!-- Search Box -->
            <Border Stroke="LightGray" StrokeThickness="1" Background="White" StrokeShape="RoundRectangle 8" Padding="10">
                <Grid ColumnDefinitions="*,100" ColumnSpacing="10">
                    <Entry Grid.Column="0"
                           Placeholder="Search physicians by name or username"
                           Text="{Binding SearchText}"
                           TextColor="#333"
                           ClearButtonVisibility="WhileEditing"/>
                    <Button Grid.Column="1"
                            Text="Search"
                            Command="{Binding SearchCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"/>
                </Grid>
            </Border>

            <!-- Action Buttons (RBAC: Only visible to administrators) -->
            <Button Text="Create New Physician"
                    Command="{Binding CreatePhysicianCommand}"
                    BackgroundColor="#4CAF50"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="45"
                    IsVisible="{Binding CanCreatePhysician}"/>

        </VerticalStackLayout>

        <!-- Physician List with SortableListView -->
        <shared:SortableListView Grid.Row="1"
                                  ItemsSource="{Binding Physicians}"
                                  SortOptions="{Binding SortOptions}"
                                  SelectedSortOption="{Binding SelectedSortOption}"
                                  IsAscending="{Binding IsAscending}"
                                  SelectedItem="{Binding SelectedPhysician}"
                                  RefreshCommand="{Binding RefreshCommand}"
                                  IsRefreshing="{Binding IsRefreshing}"
                                  EmptyMessage="No physicians found">
            <shared:SortableListView.ItemTemplate>
                    <DataTemplate x:DataType="domain:PhysicianProfile">
                        <Border Stroke="LightGray"
                                StrokeThickness="1"
                                Background="White"
                                StrokeShape="RoundRectangle 8"
                                Padding="15"
                                Margin="0,5">

                            <VerticalStackLayout Spacing="5">

                                <!-- Physician Name -->
                                <Label FontSize="18" FontAttributes="Bold">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="Dr. " TextColor="#333"/>
                                            <Span Text="{Binding Name}" TextColor="#333"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <!-- Username -->
                                <HorizontalStackLayout Spacing="5">
                                    <Label Text="Username:"
                                           FontSize="12"
                                           TextColor="Gray"
                                           FontAttributes="Bold"/>
                                    <Label Text="{Binding Username}"
                                           FontSize="12"
                                           TextColor="Gray"/>
                                </HorizontalStackLayout>

                                <!-- License Number -->
                                <HorizontalStackLayout Spacing="5">
                                    <Label Text="License:"
                                           FontSize="12"
                                           TextColor="Gray"
                                           FontAttributes="Bold"/>
                                    <Label Text="{Binding LicenseNumber}"
                                           FontSize="12"
                                           TextColor="Gray"/>
                                </HorizontalStackLayout>

                                <!-- Specializations -->
                                <Label FontSize="12" LineBreakMode="WordWrap">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="Specializations: " FontAttributes="Bold" TextColor="#2196F3"/>
                                            <Span Text="{Binding Specializations, Converter={StaticResource SpecializationsConverter}}" TextColor="#2196F3"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <!-- Patient Count -->
                                <Label FontSize="11" TextColor="Gray">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding PatientIds.Count}"/>
                                            <Span Text=" Patients"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <!-- Physician ID (Truncated) -->
                                <Label FontSize="10" TextColor="LightGray">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="ID: "/>
                                            <Span Text="{Binding Id, StringFormat='{0:N}'}"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                            </VerticalStackLayout>

                        </Border>
                    </DataTemplate>
            </shared:SortableListView.ItemTemplate>
        </shared:SortableListView>

        <!-- Validation Errors -->
        <CollectionView Grid.Row="1"
                       ItemsSource="{Binding ValidationErrors}"
                       IsVisible="{Binding HasValidationErrors}"
                       VerticalOptions="Start"
                       Margin="10">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Stroke="#F44336"
                            StrokeThickness="1"
                            Background="#FFEBEE"
                            StrokeShape="RoundRectangle 8"
                            Padding="10"
                            Margin="0,2">
                        <Label Text="{Binding .}"
                               TextColor="#D32F2F"
                               FontSize="12"/>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        </Grid>
    </Grid>

</ContentPage>
